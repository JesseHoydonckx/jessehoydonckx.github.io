<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GuessTheTrack: Educational Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Custom animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        
        /* Audio player styling */
        .audio-player {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 8px;
            outline: none;
        }
        
        .audio-player::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: #4f46e5;
            border-radius: 50%;
            cursor: pointer;
        }
        
        /* Custom scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        /* Slide-in menu */
        .menu-slide {
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
        }
        
        .menu-slide.open {
            transform: translateX(0);
        }
        
        /* Button press effect */
        .btn-press:active {
            transform: scale(0.95);
        }

        input[type="checkbox"]:checked + .block {
            background-color: #4f46e5; /* Indigo */
        }
        input[type="checkbox"]:checked ~ .dot {
            transform: translateX(24px);
            background-color: #6366f1;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen font-sans">
    <!-- Header -->
    <header class="bg-indigo-600 text-white shadow-md">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <!-- Hamburger Menu -->
            <button id="menuBtn" class="text-white focus:outline-none">
                <i class="fas fa-bars text-2xl"></i>
            </button>
            
            <!-- Title -->
            <h1 class="text-2xl md:text-3xl font-bold text-center">
                <i class="fas fa-music mr-2"></i>
                GuessTheTrack
            </h1>
            
            <!-- Placeholder for alignment -->
            <div class="w-8"></div>
        </div>
    </header>

    <!-- Side Menu -->
    <div id="sideMenu" class="menu-slide fixed top-0 left-0 w-64 h-full bg-gray-800 text-white z-50 shadow-xl">
        <div class="p-4 flex justify-between items-center border-b border-gray-700">
            <h2 class="text-xl font-bold">Menu</h2>
            <button id="closeMenuBtn" class="text-white focus:outline-none">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="p-4">
            <div class="mb-6">
                <h3 class="text-lg font-semibold mb-2">Data Management</h3>
                <button id="clearDataBtn" class="w-full bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded btn-press transition">
                    <i class="fas fa-trash-alt mr-2"></i> Reset All Progress
                </button>
            </div>
            
            <div>
                <h3 class="text-lg font-semibold mb-2">Developer Options</h3>
                
                <div class="mb-4">
                    <label class="flex items-center cursor-pointer">
                        <div class="relative">
                            <input id="quizModeToggle" type="checkbox" class="sr-only">
                            <div class="block bg-gray-600 w-14 h-8 rounded-full"></div>
                            <div class="dot absolute left-1 top-1 bg-white w-6 h-6 rounded-full transition"></div>
                        </div>
                        <div class="ml-3 text-gray-300 font-medium" id="quizModeLabel">
                            Personalized Mode
                        </div>
                    </label>
                </div>
                
                <div class="mb-4">
                    <h4 class="text-md font-medium mb-2">User Model</h4>
                    <div id="userModelDisplay" class="bg-gray-700 p-3 rounded max-h-40 overflow-y-auto custom-scrollbar text-sm">
                        No data available
                    </div>
                </div>
                
                <button id="exportDataBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-2 px-4 rounded btn-press transition">
                    <i class="fas fa-download mr-2"></i> Export User Model
                </button>
            </div>
        </div>
    </div>

    <!-- Overlay for menu -->
    <div id="menuOverlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-40"></div>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
        <!-- Home Screen -->
        <div id="homeScreen" class="text-center fade-in">
            <div class="max-w-2xl mx-auto bg-white rounded-xl shadow-md overflow-hidden p-8">
                <div class="text-indigo-600 mb-6">
                    <i class="fas fa-music text-6xl"></i>
                </div>
                <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-4">Music History Challenge</h2>
                <p class="text-gray-600 mb-6">
                    Test your knowledge of music history, genres, and cultural context. 
                    Each quiz will help you learn more about the evolution of music across decades.
                </p>
                <button id="startQuizBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-full btn-press transition transform">
                    Start Quiz <i class="fas fa-play ml-2"></i>
                </button>
            </div>
        </div>

        <!-- Quiz Screen -->
        <div id="quizScreen" class="hidden max-w-2xl mx-auto bg-white rounded-xl shadow-md overflow-hidden fade-in">
            <!-- Progress Bar -->
            <div class="bg-gray-200 h-2">
                <div id="quizProgress" class="bg-indigo-600 h-2" style="width: 0%"></div>
            </div>
            
            <div class="p-6">
                <!-- Question Counter -->
                <div class="text-right text-gray-500 mb-4">
                    Question <span id="currentQuestion">1</span>/<span id="totalQuestions">5</span>
                </div>
                
                <!-- Question Type Indicator -->
                <div id="questionTypeBadge" class="inline-block px-3 py-1 rounded-full text-xs font-semibold mb-4">
                    <i class="fas fa-question-circle mr-1"></i> Loading...
                </div>
                
                <!-- Question Content -->
                <div id="questionContent" class="mb-8">
                    <!-- Will be filled by JavaScript -->
                </div>
                
                <!-- Answer Options -->
                <div id="answerOptions" class="space-y-3 mb-6">
                    <!-- Will be filled by JavaScript -->
                </div>
                
                <!-- Feedback Section -->
                <div id="feedbackSection" class="hidden mb-6 p-4 rounded-lg">
                    <!-- Will be filled by JavaScript -->
                </div>
                
                <!-- Navigation Buttons -->
                <div class="flex justify-between">
                    <button id="submitAnswerBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded btn-press transition">
                        Submit Answer
                    </button>
                    <button id="nextQuestionBtn" class="hidden bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded btn-press transition">
                        Next Question <i class="fas fa-arrow-right ml-1"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Results Screen -->
        <div id="resultsScreen" class="hidden max-w-2xl mx-auto bg-white rounded-xl shadow-md overflow-hidden p-8 fade-in">
            <div class="text-center">
                <div class="text-green-500 mb-4">
                    <i class="fas fa-trophy text-5xl"></i>
                </div>
                <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-2">Quiz Completed!</h2>
                <p class="text-gray-600 mb-6">Here's how you performed:</p>
                
                <!-- Overall Stats -->
                <div class="bg-indigo-50 rounded-lg p-4 mb-6">
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-medium">Total Score:</span>
                        <span id="totalScore" class="font-bold text-xl">0/5</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="font-medium">Accuracy:</span>
                        <span id="accuracyRate" class="font-bold text-xl">0%</span>
                    </div>
                </div>
                
                <!-- Performance by Category -->
                <h3 class="text-lg font-semibold text-left mb-3">Performance by Category</h3>
                <div class="space-y-4 mb-8">
                    <div>
                        <div class="flex justify-between mb-1">
                            <span class="text-sm font-medium">Genres</span>
                            <span id="genreAccuracy" class="text-sm font-medium">0%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5">
                            <div id="genreProgress" class="bg-indigo-600 h-2.5 rounded-full" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div>
                        <div class="flex justify-between mb-1">
                            <span class="text-sm font-medium">Eras</span>
                            <span id="eraAccuracy" class="text-sm font-medium">0%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5">
                            <div id="eraProgress" class="bg-indigo-600 h-2.5 rounded-full" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div>
                        <div class="flex justify-between mb-1">
                            <span class="text-sm font-medium">Question Types</span>
                            <span id="typeAccuracy" class="text-sm font-medium">0%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5">
                            <div id="typeProgress" class="bg-indigo-600 h-2.5 rounded-full" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Restart Button -->
                <button id="restartQuizBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-full btn-press transition">
                    <i class="fas fa-redo mr-2"></i> Take Another Quiz
                </button>
            </div>
        </div>
    </main>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full">
            <h3 class="text-lg font-bold text-gray-800 mb-4">Confirm Reset</h3>
            <p class="text-gray-600 mb-6">Are you sure you want to reset all your progress? This action cannot be undone.</p>
            <div class="flex justify-end space-x-3">
                <button id="cancelResetBtn" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                    Cancel
                </button>
                <button id="confirmResetBtn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">
                    Reset
                </button>
            </div>
        </div>
    </div>

    <script>
        // Quiz Data
        const quizData = [
            // Audio questions
            {
                type: "audio",
                audioSrc: "https://freemusicarchive.org/music/art-flower/lets-rock/art-flower-gitano-waltz/",
                question: "Listen to this 10-second audio clip. Which era does this song belong to?",
                options: ["1960s", "1980s", "2000s", "2020s"],
                correctAnswer: "1980s",
                explanation: "This song features the distinctive synthesizer sounds that were popular in 1980s pop music.",
                genre: "Pop",
                era: "1980s"
            },
            {
                type: "audio",
                audioSrc: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3",
                question: "What genre best describes this musical excerpt?",
                options: ["Jazz", "Blues", "Rock", "Classical"],
                correctAnswer: "Jazz",
                explanation: "The improvisational nature and swing rhythm are characteristic of jazz music.",
                genre: "Jazz",
                era: "1950s"
            },
            // Context questions
            {
                type: "context",
                question: "Which instrument became a defining sound of rock music in the 1960s?",
                options: ["Electric Guitar", "Piano", "Saxophone", "Violin"],
                correctAnswer: "Electric Guitar",
                explanation: "The electric guitar, with artists like Jimi Hendrix and Eric Clapton, became the iconic instrument of 1960s rock.",
                genre: "Rock",
                era: "1960s"
            },
            {
                type: "context",
                question: "What cultural movement was closely associated with the rise of hip-hop in the 1970s?",
                options: ["Beat Generation", "Harlem Renaissance", "Civil Rights Movement", "Black Power Movement"],
                correctAnswer: "Black Power Movement",
                explanation: "Hip-hop emerged as a cultural expression of urban African American communities during the Black Power era.",
                genre: "Hip-Hop",
                era: "1970s"
            },
            {
                type: "context",
                question: "Which of these technological advancements had the biggest impact on music distribution in the 2000s?",
                options: ["MP3 Players", "Vinyl Records", "Cassette Tapes", "CD Players"],
                correctAnswer: "MP3 Players",
                explanation: "The rise of MP3 players and digital downloads revolutionized how people accessed music in the 2000s.",
                genre: "Various",
                era: "2000s"
            },
            {
                type: "audio",
                audioSrc: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3",
                question: "This musical style originated in which decade?",
                options: ["1920s", "1940s", "1960s", "1980s"],
                correctAnswer: "1920s",
                explanation: "This early jazz style with its distinctive rhythms was popular in the 1920s, often called the Jazz Age.",
                genre: "Jazz",
                era: "1920s"
            },
            {
                type: "context",
                question: "What was the 'British Invasion' in music history?",
                options: [
                    "A wave of British rock bands that became popular in the US in the 1960s",
                    "When classical music became popular in Britain",
                    "The introduction of American jazz to Britain",
                    "A military conflict over music rights"
                ],
                correctAnswer: "A wave of British rock bands that became popular in the US in the 1960s",
                explanation: "The British Invasion refers to British bands like The Beatles and The Rolling Stones dominating American charts in the mid-1960s.",
                genre: "Rock",
                era: "1960s"
            }
        ];

        // App State
        const state = {
            currentQuestionIndex: 0,
            score: 0,
            quizLength: 5,
            selectedAnswer: null,
            isAnswerSubmitted: false,
            userModel: {
                genres: {},
                eras: {},
                types: {},
                totalQuestions: 0,
                correctAnswers: 0
            },
            currentQuiz: [],
            sessionAnswers: [],
            personalizedMode: true
        };

        // DOM Elements
        const elements = {
            // Screens
            homeScreen: document.getElementById('homeScreen'),
            quizScreen: document.getElementById('quizScreen'),
            resultsScreen: document.getElementById('resultsScreen'),
            
            // Menu
            menuBtn: document.getElementById('menuBtn'),
            closeMenuBtn: document.getElementById('closeMenuBtn'),
            sideMenu: document.getElementById('sideMenu'),
            menuOverlay: document.getElementById('menuOverlay'),
            
            // Quiz Controls
            startQuizBtn: document.getElementById('startQuizBtn'),
            submitAnswerBtn: document.getElementById('submitAnswerBtn'),
            nextQuestionBtn: document.getElementById('nextQuestionBtn'),
            restartQuizBtn: document.getElementById('restartQuizBtn'),
            
            // Quiz Display
            questionContent: document.getElementById('questionContent'),
            answerOptions: document.getElementById('answerOptions'),
            feedbackSection: document.getElementById('feedbackSection'),
            questionTypeBadge: document.getElementById('questionTypeBadge'),
            currentQuestion: document.getElementById('currentQuestion'),
            totalQuestions: document.getElementById('totalQuestions'),
            quizProgress: document.getElementById('quizProgress'),
            
            // Results Display
            totalScore: document.getElementById('totalScore'),
            accuracyRate: document.getElementById('accuracyRate'),
            genreAccuracy: document.getElementById('genreAccuracy'),
            eraAccuracy: document.getElementById('eraAccuracy'),
            typeAccuracy: document.getElementById('typeAccuracy'),
            genreProgress: document.getElementById('genreProgress'),
            eraProgress: document.getElementById('eraProgress'),
            typeProgress: document.getElementById('typeProgress'),
            
            // Settings
            quizModeToggle: document.getElementById('quizModeToggle'),
            userModelDisplay: document.getElementById('userModelDisplay'),
            quizModeLabel: document.getElementById('quizModeLabel'),
            exportDataBtn: document.getElementById('exportDataBtn'),
            clearDataBtn: document.getElementById('clearDataBtn'),
            
            // Modals
            confirmModal: document.getElementById('confirmModal'),
            cancelResetBtn: document.getElementById('cancelResetBtn'),
            confirmResetBtn: document.getElementById('confirmResetBtn')
        };

        // Initialize the app
        function init() {
            loadUserModel();
            setupEventListeners();
            updateUI();
        }

        // Load user model from local storage
        function loadUserModel() {
            const savedModel = localStorage.getItem('guessTheTrackUserModel');
            if (savedModel) {
                state.userModel = JSON.parse(savedModel);
            }
            
            const savedMode = localStorage.getItem('guessTheTrackMode');
            if (savedMode) {
                state.personalizedMode = savedMode === 'personalized';
                elements.quizModeToggle.checked = state.personalizedMode;
            }
            
            updateQuizModeLabel();
            updateUserModelDisplay();
        }

        // Save user model to local storage
        function saveUserModel() {
            localStorage.setItem('guessTheTrackUserModel', JSON.stringify(state.userModel));
            localStorage.setItem('guessTheTrackMode', state.personalizedMode ? 'personalized' : 'random');
            updateUserModelDisplay();
        }

        // Update the user model display in the menu
        function updateUserModelDisplay() {
            if (Object.keys(state.userModel.genres).length === 0 && 
                Object.keys(state.userModel.eras).length === 0 &&
                Object.keys(state.userModel.types).length === 0) {
                elements.userModelDisplay.innerHTML = 'No data available';
                return;
            }
            
            let html = '<div class="grid grid-cols-3 gap-2 text-xs">';
            html += '<div class="font-bold">Category</div><div class="font-bold">Attempts</div><div class="font-bold">Accuracy</div>';
            
            // Add genres
            html += '<div class="col-span-3 mt-1 font-medium">Genres</div>';
            for (const [genre, stats] of Object.entries(state.userModel.genres)) {
                const accuracy = stats.attempts > 0 ? Math.round((stats.correct / stats.attempts) * 100) : 0;
                html += `<div>${genre}</div><div>${stats.attempts}</div><div>${accuracy}%</div>`;
            }
            
            // Add eras
            html += '<div class="col-span-3 mt-1 font-medium">Eras</div>';
            for (const [era, stats] of Object.entries(state.userModel.eras)) {
                const accuracy = stats.attempts > 0 ? Math.round((stats.correct / stats.attempts) * 100) : 0;
                html += `<div>${era}</div><div>${stats.attempts}</div><div>${accuracy}%</div>`;
            }
            
            // Add types
            html += '<div class="col-span-3 mt-1 font-medium">Question Types</div>';
            for (const [type, stats] of Object.entries(state.userModel.types)) {
                const accuracy = stats.attempts > 0 ? Math.round((stats.correct / stats.attempts) * 100) : 0;
                html += `<div>${type}</div><div>${stats.attempts}</div><div>${accuracy}%</div>`;
            }
            
            html += '</div>';
            elements.userModelDisplay.innerHTML = html;
        }

        // Set up event listeners
        function setupEventListeners() {
            // Menu controls
            elements.menuBtn.addEventListener('click', toggleMenu);
            elements.closeMenuBtn.addEventListener('click', toggleMenu);
            elements.menuOverlay.addEventListener('click', toggleMenu);
            
            // Quiz controls
            elements.startQuizBtn.addEventListener('click', startQuiz);
            elements.submitAnswerBtn.addEventListener('click', submitAnswer);
            elements.nextQuestionBtn.addEventListener('click', nextQuestion);
            elements.restartQuizBtn.addEventListener('click', startQuiz);
            
            // Settings
            elements.quizModeToggle.addEventListener('change', toggleQuizMode);
            elements.exportDataBtn.addEventListener('click', exportUserModel);
            elements.clearDataBtn.addEventListener('click', showResetConfirmation);
            elements.cancelResetBtn.addEventListener('click', hideResetConfirmation);
            elements.confirmResetBtn.addEventListener('click', resetUserModel);
        }

        // Toggle the side menu
        function toggleMenu() {
            elements.sideMenu.classList.toggle('open');
            elements.menuOverlay.classList.toggle('hidden');
            
            // Prevent scrolling when menu is open
            if (elements.sideMenu.classList.contains('open')) {
                document.body.style.overflow = 'hidden';
            } else {
                document.body.style.overflow = '';
            }
        }

        // Toggle quiz mode between random and personalized
        function toggleQuizMode() {
            state.personalizedMode = elements.quizModeToggle.checked;
            saveUserModel();
            updateQuizModeLabel();
        }

        // Show reset confirmation modal
        function showResetConfirmation() {
            elements.confirmModal.classList.remove('hidden');
        }

        // Hide reset confirmation modal
        function hideResetConfirmation() {
            elements.confirmModal.classList.add('hidden');
        }

        // Reset user model
        function resetUserModel() {
            state.userModel = {
                genres: {},
                eras: {},
                types: {},
                totalQuestions: 0,
                correctAnswers: 0
            };
            saveUserModel();
            hideResetConfirmation();
        }

        // Export user model as JSON file
        function exportUserModel() {
            const dataStr = JSON.stringify(state.userModel, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `GuessTheTrack_UserModel_${new Date().toISOString().slice(0, 10)}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }

        // Start a new quiz
        function startQuiz() {
            // Reset quiz state
            state.currentQuestionIndex = 0;
            state.score = 0;
            state.selectedAnswer = null;
            state.isAnswerSubmitted = false;
            state.sessionAnswers = [];
            
            // Select questions based on mode
            if (state.personalizedMode) {
                selectPersonalizedQuestions();
            } else {
                // Random mode - shuffle all questions and take first N
                state.currentQuiz = [...quizData].sort(() => 0.5 - Math.random()).slice(0, state.quizLength);
            }
            
            // Update UI
            elements.homeScreen.classList.add('hidden');
            elements.resultsScreen.classList.add('hidden');
            elements.quizScreen.classList.remove('hidden');
            
            // Show first question
            showQuestion();
        }

        function updateQuizModeLabel() {
            elements.quizModeLabel.textContent = state.personalizedMode ? 'Personalized Mode' : 'Random Mode';
        }

        // Select questions based on user's weak areas
        function selectPersonalizedQuestions() {
            // Calculate weights for each question based on user performance
            const weightedQuestions = quizData.map(question => {
                // Default weight for new categories
                let weight = 5;
                
                // Adjust weight based on genre performance
                const genreStats = state.userModel.genres[question.genre] || { attempts: 0, correct: 0 };
                const genreAccuracy = genreStats.attempts > 0 ? (genreStats.correct / genreStats.attempts) : 0;
                weight += (1 - genreAccuracy) * 10; // More weight to less accurate genres
                
                // Adjust weight based on era performance
                const eraStats = state.userModel.eras[question.era] || { attempts: 0, correct: 0 };
                const eraAccuracy = eraStats.attempts > 0 ? (eraStats.correct / eraStats.attempts) : 0;
                weight += (1 - eraAccuracy) * 10; // More weight to less accurate eras
                
                // Adjust weight based on question type performance
                const typeStats = state.userModel.types[question.type] || { attempts: 0, correct: 0 };
                const typeAccuracy = typeStats.attempts > 0 ? (typeStats.correct / typeStats.attempts) : 0;
                weight += (1 - typeAccuracy) * 5; // Some weight to less accurate types
                
                return { question, weight };
            });
            
            // Sort by weight (higher weights first)
            weightedQuestions.sort((a, b) => b.weight - a.weight);
            
            // Select questions - 70% from top weights (weak areas), 30% random
            const weakAreaCount = Math.floor(state.quizLength * 0.7);
            const randomCount = state.quizLength - weakAreaCount;
            
            // Take top weighted questions
            const selectedQuestions = weightedQuestions.slice(0, weakAreaCount).map(item => item.question);
            
            // Add some random questions from the rest
            const remainingQuestions = weightedQuestions.slice(weakAreaCount).map(item => item.question);
            const randomQuestions = [...remainingQuestions].sort(() => 0.5 - Math.random()).slice(0, randomCount);
            
            state.currentQuiz = [...selectedQuestions, ...randomQuestions].sort(() => 0.5 - Math.random());
        }

        // Display the current question
        function showQuestion() {
            const currentQuestion = state.currentQuiz[state.currentQuestionIndex];
            
            // Update question counter
            elements.currentQuestion.textContent = state.currentQuestionIndex + 1;
            elements.totalQuestions.textContent = state.quizLength;
            elements.quizProgress.style.width = `${(state.currentQuestionIndex / state.quizLength) * 100}%`;
            
            // Reset answer state
            state.selectedAnswer = null;
            state.isAnswerSubmitted = false;
            
            // Update question type badge
            elements.questionTypeBadge.className = `inline-block px-3 py-1 rounded-full text-xs font-semibold mb-4 ${
                currentQuestion.type === 'audio' ? 'bg-blue-100 text-blue-800' : 'bg-purple-100 text-purple-800'
            }`;
            elements.questionTypeBadge.innerHTML = `<i class="fas fa-${
                currentQuestion.type === 'audio' ? 'music' : 'book'
            } mr-1"></i> ${currentQuestion.type === 'audio' ? 'Audio Clip' : 'Context Question'}`;
            
            // Clear previous content
            elements.questionContent.innerHTML = '';
            elements.answerOptions.innerHTML = '';
            elements.feedbackSection.classList.add('hidden');
            elements.submitAnswerBtn.classList.remove('hidden');
            elements.nextQuestionBtn.classList.add('hidden');
            
            // Display question content
            const questionEl = document.createElement('p');
            questionEl.className = 'text-lg font-medium text-gray-800 mb-4';
            questionEl.textContent = currentQuestion.question;
            elements.questionContent.appendChild(questionEl);
            
            // Add audio player if it's an audio question
            if (currentQuestion.type === 'audio') {
                const audioContainer = document.createElement('div');
                audioContainer.className = 'mb-6';
                
                const audioEl = document.createElement('audio');
                audioEl.className = 'w-full mb-2';
                audioEl.controls = true;
                audioEl.src = currentQuestion.audioSrc;
                
                const audioControls = document.createElement('div');
                audioControls.className = 'flex items-center justify-center space-x-4';
                
                const playBtn = document.createElement('button');
                playBtn.className = 'bg-indigo-600 text-white p-3 rounded-full btn-press';
                playBtn.innerHTML = '<i class="fas fa-play"></i>';
                playBtn.addEventListener('click', () => {
                    audioEl.play();
                });
                
                audioControls.appendChild(playBtn);
                audioContainer.appendChild(audioEl);
                audioContainer.appendChild(audioControls);
                elements.questionContent.appendChild(audioContainer);
            }
            
            // Add answer options
            currentQuestion.options.forEach((option, index) => {
                const optionContainer = document.createElement('div');
                optionContainer.className = 'flex items-center p-3 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition';
                optionContainer.dataset.answer = option;
                
                const radioBtn = document.createElement('div');
                radioBtn.className = 'w-5 h-5 rounded-full border-2 border-gray-300 mr-3 flex-shrink-0';
                
                const optionText = document.createElement('span');
                optionText.className = 'text-gray-700';
                optionText.textContent = option;
                
                optionContainer.appendChild(radioBtn);
                optionContainer.appendChild(optionText);
                
                optionContainer.addEventListener('click', () => selectAnswer(optionContainer, option));
                elements.answerOptions.appendChild(optionContainer);
            });
        }

        // Handle answer selection
        function selectAnswer(container, answer) {
            // Deselect all options
            document.querySelectorAll('#answerOptions > div').forEach(opt => {
                opt.classList.remove('bg-indigo-50', 'border-indigo-300');
                opt.querySelector('div').className = 'w-5 h-5 rounded-full border-2 border-gray-300 mr-3 flex-shrink-0';
            });
            
            // Select the clicked option
            container.classList.add('bg-indigo-50', 'border-indigo-300');
            container.querySelector('div').className = 'w-5 h-5 rounded-full border-2 border-indigo-500 mr-3 flex-shrink-0 bg-indigo-100 flex items-center justify-center';
            container.querySelector('div').innerHTML = '<div class="w-2 h-2 rounded-full bg-indigo-600"></div>';
            
            state.selectedAnswer = answer;
        }

        // Submit the selected answer
        function submitAnswer() {
            if (!state.selectedAnswer) {
                alert('Please select an answer before submitting.');
                return;
            }
            
            const currentQuestion = state.currentQuiz[state.currentQuestionIndex];
            const isCorrect = state.selectedAnswer === currentQuestion.correctAnswer;
            
            // Update score
            if (isCorrect) {
                state.score++;
            }
            
            // Track this answer in session
            state.sessionAnswers.push({
                question: currentQuestion.question,
                selectedAnswer: state.selectedAnswer,
                correctAnswer: currentQuestion.correctAnswer,
                isCorrect,
                genre: currentQuestion.genre,
                era: currentQuestion.era,
                type: currentQuestion.type
            });
            
            // Update user model
            updateUserModelWithAnswer(currentQuestion, isCorrect);
            
            // Show feedback
            showFeedback(currentQuestion, isCorrect);
            
            state.isAnswerSubmitted = true;
            elements.submitAnswerBtn.classList.add('hidden');
            
            // Show next button if not last question
            if (state.currentQuestionIndex < state.quizLength - 1) {
                elements.nextQuestionBtn.classList.remove('hidden');
            } else {
                // Last question - show finish button
                elements.nextQuestionBtn.classList.add('hidden');
                setTimeout(showResults, 1000);
            }
        }

        // Update user model with answer data
        function updateUserModelWithAnswer(question, isCorrect) {
            // Update genre stats
            if (!state.userModel.genres[question.genre]) {
                state.userModel.genres[question.genre] = { attempts: 0, correct: 0 };
            }
            state.userModel.genres[question.genre].attempts++;
            if (isCorrect) state.userModel.genres[question.genre].correct++;
            
            // Update era stats
            if (!state.userModel.eras[question.era]) {
                state.userModel.eras[question.era] = { attempts: 0, correct: 0 };
            }
            state.userModel.eras[question.era].attempts++;
            if (isCorrect) state.userModel.eras[question.era].correct++;
            
            // Update type stats
            if (!state.userModel.types[question.type]) {
                state.userModel.types[question.type] = { attempts: 0, correct: 0 };
            }
            state.userModel.types[question.type].attempts++;
            if (isCorrect) state.userModel.types[question.type].correct++;
            
            // Update overall stats
            state.userModel.totalQuestions++;
            if (isCorrect) state.userModel.correctAnswers++;
            
            saveUserModel();
        }

        // Show feedback for the submitted answer
        function showFeedback(question, isCorrect) {
            elements.feedbackSection.classList.remove('hidden');
            elements.feedbackSection.className = `p-4 rounded-lg mb-6 ${
                isCorrect ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
            }`;
            
            let feedbackHTML = `
                <div class="font-bold mb-2">
                    <i class="fas fa-${isCorrect ? 'check-circle' : 'times-circle'} mr-2"></i>
                    ${isCorrect ? 'Correct!' : 'Incorrect'}
                </div>
                <div class="mb-2">${question.explanation}</div>
            `;
            
            if (!isCorrect) {
                feedbackHTML += `<div class="font-medium">Correct answer: ${question.correctAnswer}</div>`;
            }
            
            elements.feedbackSection.innerHTML = feedbackHTML;
        }

        // Move to the next question
        function nextQuestion() {
            state.currentQuestionIndex++;
            showQuestion();
        }

        // Show quiz results
        function showResults() {
            // Calculate stats
            const accuracy = Math.round((state.score / state.quizLength) * 100);
            
            // Calculate category accuracies
            const genreStats = calculateCategoryAccuracy(state.sessionAnswers, 'genre');
            const eraStats = calculateCategoryAccuracy(state.sessionAnswers, 'era');
            const typeStats = calculateCategoryAccuracy(state.sessionAnswers, 'type');
            
            // Update UI
            elements.totalScore.textContent = `${state.score}/${state.quizLength}`;
            elements.accuracyRate.textContent = `${accuracy}%`;
            
            elements.genreAccuracy.textContent = `${genreStats.accuracy}%`;
            elements.eraAccuracy.textContent = `${eraStats.accuracy}%`;
            elements.typeAccuracy.textContent = `${typeStats.accuracy}%`;
            
            elements.genreProgress.style.width = `${genreStats.accuracy}%`;
            elements.eraProgress.style.width = `${eraStats.accuracy}%`;
            elements.typeProgress.style.width = `${typeStats.accuracy}%`;
            
            // Switch screens
            elements.quizScreen.classList.add('hidden');
            elements.resultsScreen.classList.remove('hidden');
        }

        // Calculate accuracy for a specific category
        function calculateCategoryAnswers(sessionAnswers, category) {
            const categoryAnswers = {};
            
            sessionAnswers.forEach(answer => {
                const key = answer[category];
                if (!categoryAnswers[key]) {
                    categoryAnswers[key] = { correct: 0, total: 0 };
                }
                
                categoryAnswers[key].total++;
                if (answer.isCorrect) {
                    categoryAnswers[key].correct++;
                }
            });
            
            return categoryAnswers;
        }

        // Calculate overall accuracy for a category
        function calculateCategoryAccuracy(sessionAnswers, category) {
            const categoryAnswers = calculateCategoryAnswers(sessionAnswers, category);
            let totalCorrect = 0;
            let totalQuestions = 0;
            
            for (const [key, stats] of Object.entries(categoryAnswers)) {
                totalCorrect += stats.correct;
                totalQuestions += stats.total;
            }
            
            const accuracy = totalQuestions > 0 ? Math.round((totalCorrect / totalQuestions) * 100) : 0;
            
            return {
                accuracy,
                categoryAnswers
            };
        }

        // Update UI based on app state
        function updateUI() {
            // Nothing needed here currently as all UI updates are handled in specific functions
        }

        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
